name: Release

on:
  push:
    branches: [main]

concurrency:
  group: release
  cancel-in-progress: false

env:
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================================================
  # Stage 1: Releases (run in parallel)
  # ===========================================================================

  root-release:
    name: Root Release
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run semantic-release
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  stream-finder-release:
    name: stream-finder Release
    runs-on: ubuntu-latest
    needs: [root-release]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Python Semantic Release
        id: semrel
        uses: python-semantic-release/python-semantic-release@v10
        with:
          directory: packages/stream-finder
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish GitHub Release
        if: steps.semrel.outputs.released == 'true'
        uses: python-semantic-release/publish-action@v10
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.semrel.outputs.tag }}

  explore-release:
    name: explore Release
    runs-on: ubuntu-latest
    needs: [root-release]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Python Semantic Release
        id: semrel
        uses: python-semantic-release/python-semantic-release@v10
        with:
          directory: packages/explore
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish GitHub Release
        if: steps.semrel.outputs.released == 'true'
        uses: python-semantic-release/publish-action@v10
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.semrel.outputs.tag }}

  # ===========================================================================
  # Stage 2: Deploy docs (after releases, so version badge is up to date)
  # ===========================================================================

  deploy-docs:
    name: Deploy Docs
    runs-on: ubuntu-latest
    needs: [root-release, stream-finder-release, explore-release]
    if: ${{ !cancelled() && !contains(github.event.head_commit.message, '[skip ci]') }}
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build docs
        run: yarn workspace @topology-streams/docs build

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: packages/docs/build/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ===========================================================================
  # Stage 2: Deploy infrastructure (parallel with docs, after releases)
  # ===========================================================================

  deploy-infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [root-release, stream-finder-release, explore-release]
    if: ${{ !cancelled() && !contains(github.event.head_commit.message, '[skip ci]') }}
    permissions:
      contents: read
      id-token: write
    environment: development
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT }}:role/TopoStreams-GitHubActions-Role
          aws-region: ${{ vars.AWS_DEFAULT_REGION || 'us-east-1' }}

      - name: Set up QEMU (ARM64 emulation for Docker builds)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Deploy CDK
        run: yarn workspace @topology-streams/infrastructure deploy --all --require-approval never
        env:
          ENVIRONMENT: development
          AWS_ACCOUNT: ${{ secrets.AWS_ACCOUNT }}
          AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION || 'us-east-1' }}
